<!doctype html> 
<html lang="en"> 
    <head> 
        <meta charset="UTF-8" />
        <title>Making your first Phaser 3 Game - Part 10</title>
        <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
        <style type="text/css">
            body {
                margin: 0;
            }
        </style>
    </head>
    <body>

        <script type="text/javascript">
			
			var player;
            var player1;
            var player2;
            var player3;
            var stars;
            var bombs;
            var colliders;
            var cursors;
            var score = 0;
            var gameOver = false;
            var scoreText;
			var jumptimer;
			var jumptimer1;
			var jumptimer2;
			var jumptimer3;

            
		/*var MainMenu = new Phaser.Class({
			Extends: Phaser.Scene,
			Initialize:
			
				function MainMenu(){
					Phaser.Scene.call(this, {key: 'MainMenu'});
				},*/
		class MainMenu extends Phaser.Scene{
		
			constructor(){
				super("MainMenu");
			}
				preload()
				{
					this.load.image('sky', 'assets/sky.png');
				}
				
				create()
				{
					this.add.image(400, 300, 'sky');
					var texto = this.add.text(game.config.width/2, game.config.height / 2, 'Press Enter to start',{
						fontSize: '40px',
						fill: '#000000'
					}).setOrigin(0.5)					
				}
				
				update()
				{
					if(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER).isDown){
						this.scene.start("EscenaJuego");
					}
				}
		}

		
		/*var EscenaJuego = new Phaser.Class({
			Extends: Phaser.Scene,
			Initialize:
				function EscenaJuego(){
					Phaser.Scene.call(this, {key: 'EscenaJuego'});
				},*/
		class EscenaJuego extends Phaser.Scene{
			
			constructor(){
				super("EscenaJuego");
			}
				
            preload()
            {
                this.load.image('sky', 'assets/sky.png');
                this.load.image('collider', 'assets/collider.png');
                this.load.image('star', 'assets/star.png');
                this.load.image('bomb', 'assets/bomb.png');
                this.load.spritesheet('dude', 'assets/dude.png', {frameWidth: 32, frameHeight: 48});
            }
			
            create()
            {						
                //  A simple background for our game
                this.add.image(400, 300, 'sky');

                //  The platforms group contains the ground and the 2 ledges we can jump on
                colliders = this.physics.add.staticGroup();

                //  Here we create the Ground COLLIDERS.
                colliders.create(100, 400, 'collider').setScale(0.2).refreshBody();
                colliders.create(700, 400, 'collider').setScale(0.2).refreshBody();
                colliders.create(400, 550, 'collider').setScale(0.2).refreshBody();
                colliders.create(400, 250, 'collider').setScale(0.2).refreshBody();

                // The PLAYERS and its settings
                player  = this.physics.add.sprite(100, 350, 'dude');
                player1 = this.physics.add.sprite(700, 350, 'dude');
                player2 = this.physics.add.sprite(400, 500, 'dude');
                player3 = this.physics.add.sprite(400, 200, 'dude');

                //  Player physics properties. Give the little guy a slight bounce.
                player.setBounce(0.2);
                player1.setBounce(0.2);
                player2.setBounce(0.2);
                player3.setBounce(0.2);

                //  Our player animations, turning, walking left and walking right.
                this.anims.create({
                    key: 'left',
                    frames: this.anims.generateFrameNumbers('dude', {start: 0, end: 3}),
                    frameRate: 10,
                    repeat: -1
                });

                this.anims.create({
                    key: 'turn',
                    frames: [{key: 'dude', frame: 4}],
                    frameRate: 20
                });

                this.anims.create({
                    key: 'right',
                    frames: this.anims.generateFrameNumbers('dude', {start: 5, end: 8}),
                    frameRate: 10,
                    repeat: -1
                });

                //  Input Events
                cursors = this.input.keyboard.createCursorKeys();

                //  Some stars to collect, 12 in total, evenly spaced 70 pixels apart along the x axis
                stars = this.physics.add.group({
                    key: 'star',
                    repeat: 11,
                    setXY: {x: 12, y: 0, stepX: 70}
                });

                stars.children.iterate(function (child) {

                    //  Give each star a slightly different bounce
                    child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

                });

                bombs = this.physics.add.group();

                //  The score
                scoreText = this.add.text(16, 16, 'score: 0', {fontSize: '32px', fill: '#000'});

                //  Collide the PLAYERS and the stars with the platforms
                this.physics.add.collider(player, colliders);
                this.physics.add.collider(player1, colliders);
                this.physics.add.collider(player2, colliders);
                this.physics.add.collider(player3, colliders);
                this.physics.add.collider(stars, colliders);
                this.physics.add.collider(bombs, colliders);

                //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
                this.physics.add.overlap(player, stars, this.collectStar, null, this);

                this.physics.add.collider(player, bombs, this.hitBomb, null, this);
            }

            update()
            {
				if(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.TAB).ESC){
					this.scene.start("MainMenu");
				}
				
                if (gameOver)
                {
					//volver al menu principal
					this.scene.start("MainMenu");
                    //return;
                }

//PLAYER LEFT
                if (cursors.left.isDown && player.body.touching.down)
            {   //player en el suelo y puede saltar
                jumptimer = 1;
                player.body.velocity.y = -150;
            } else if (cursors.left.isDown && (jumptimer != 0))
            { //player esta en el aire pulsando la tecla de saltar todavia
                if (jumptimer > 25) { // player lleva 30 frames en el aire
                    jumptimer = 0;
                } else { // player puede seguir saltando, no ha alcanzado los 30 frames
                    jumptimer++;
                    player.body.velocity.y = -150;
                }
            } else if (jumptimer != 0) { //reset jumptimer al dejar de pulsar la tecla
                jumptimer = 0;
            }
			
//PLAYER 1 RIGHT			

                if (cursors.right.isDown && player1.body.touching.down)
            {   
                jumptimer1 = 1;
                player1.body.velocity.y = -150;
            } else if (cursors.right.isDown && (jumptimer1 != 0))
            { 
                if (jumptimer1 > 25) { 
                    jumptimer1 = 0;
                } else { 
                    jumptimer1++;
                    player1.body.velocity.y = -150;
                }
            } else if (jumptimer1 != 0) { 
                jumptimer1 = 0;
            }
				
//PLAYER 2 DOWN		

                if (cursors.down.isDown && player2.body.touching.down)
            {   
                jumptimer2 = 1;
                player2.body.velocity.y = -150;
            } else if (cursors.down.isDown && (jumptimer2 != 0))
            { 
                if (jumptimer2 > 25) { 
                    jumptimer2 = 0;
                } else { 
                    jumptimer2++;
                    player2.body.velocity.y = -150;
                }
            } else if (jumptimer2 != 0) { 
                jumptimer2 = 0;
            }
				
//PLAYER 3 UP				

                if (cursors.up.isDown && player3.body.touching.down)
            {   
                jumptimer3 = 1;
                player3.body.velocity.y = -150;
            } else if (cursors.up.isDown && (jumptimer3 != 0))
            { 
                if (jumptimer3 > 25) { 
                    jumptimer3 = 0;
                } else { 
                    jumptimer3++;
                    player3.body.velocity.y = -150;
                }
            } else if (jumptimer3 != 0) { 
                jumptimer3 = 0;
            }


            }

            collectStar(player, star)
            {
                star.disableBody(true, true);

                //  Add and update the score
                score += 10;
                scoreText.setText('Score: ' + score);

                if (stars.countActive(true) === 0)
                {
                    //  A new batch of stars to collect
                    stars.children.iterate(function (child) {

                        child.enableBody(true, child.x, 0, true, true);

                    });

                    var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

                    var bomb = bombs.create(x, 16, 'bomb');
                    bomb.setBounce(1);
                    bomb.setCollideWorldBounds(true);
                    bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
                    bomb.allowGravity = false;

                }
            }
			
            hitBomb(player, bomb)
            {
                this.physics.pause();

                player.setTint(0xff0000);

                player.anims.play('turn');

                gameOver = true;
            }
		};
		
		var config = 
		{
		type: Phaser.AUTO,
		width: 800,
		height: 600,
		physics: {
		default: 'arcade',
			arcade: {
				gravity: {y: 300},
				debug: false
				}
			},
			scene: [MainMenu,EscenaJuego]
				/*{
                    preload: preload,
                    create: create,
                    update: update
                }*/
		};
            
		var game = new Phaser.Game(config);

        </script>

    </body>
</html>